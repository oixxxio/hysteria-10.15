name: Build for Legacy macOS

on:
  push:
    branches:
      - master

  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    env:
      CGO_ENABLED: 1
      GOOS: darwin
      GOARCH: amd64
      CGO_LDFLAGS: "-mmacosx-version-min=10.15"
      CGO_CFLAGS: "-mmacosx-version-min=10.15"

    steps:
    - name: â¬‡ï¸ Check out
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Setup Go (Go 1.22 & Cache)
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        cache: true

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: ğŸ“¦ Cache Pip Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ“¦ Install Hyperbole Dependencies
      run: pip install -r requirements.txt
        
    - name: âš™ï¸ Run Hyperbole Build Script
      id: hyperbole_build
      run: python hyperbole.py build -p

    - name: ğŸ” Find and Prepare Binary
      id: find_binary
      run: |
        FINAL_NAME="hysteria-darwin-amd64"
        SOURCE_PATH=$(find build/ -type f -name "$FINAL_NAME" | head -n 1)

        if [ -f "$SOURCE_PATH" ]; then
          chmod +x "$SOURCE_PATH"
          echo "binary_path=$SOURCE_PATH" >> $GITHUB_OUTPUT
        else
          echo "âŒ Error: Could not find the compiled binary $FINAL_NAME in the 'build/' directory."
          exit 1
        fi
    
    - name: ğŸ“¤ Upload Compiled Artifact
      if: success() && steps.find_binary.outputs.binary_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: hysteria-darwin-amd64
        path: ${{ steps.find_binary.outputs.binary_path }}
        retention-days: 30
